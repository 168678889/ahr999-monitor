name: Ahr999æ™ºèƒ½ç›‘æ§ç³»ç»Ÿ
on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿæ£€æµ‹ï¼Œå¹³è¡¡é¢‘ç‡ä¸ç¨³å®šæ€§
  workflow_dispatch:        # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  ahr999-monitor:
    runs-on: ubuntu-latest
    steps:
    # ========== ç¯å¢ƒå‡†å¤‡ ==========
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgbm-dev \
          libxshmfence-dev \
          libasound2 \
          libnss3 \
          libatk1.0-0
      
    # ========== æ•°æ®æŠ“å–æ¨¡å— ==========
    - name: åŠ¨æ€é¡µé¢æŠ“å–
      id: data-crawler
      uses: browser-actions/setup-puppeteer@v1.2.0
      with:
        args: |
          const puppeteer = require('puppeteer');
          (async () => {
            // æµè§ˆå™¨é…ç½®ï¼ˆé˜²å´©æºƒä¼˜åŒ–ï¼‰
            const browser = await puppeteer.launch({
              headless: 'new',  // æ–°ç‰ˆæ— å¤´æ¨¡å¼
              args: [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--single-process'
              ],
              timeout: 60000
            });

            try {
              const page = await browser.newPage();
            
              // ååçˆ¬ç­–ç•¥ï¼šæ¨¡æ‹ŸçœŸå®æµè§ˆå™¨
              await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');
              await page.setExtraHTTPHeaders({
                'Accept-Language': 'en-US,en;q=0.9',
                'Referer': 'https://www.feixiaohao.com/'
              });

              // ===== ä¸»æ•°æ®æºï¼šé£å°å·é¡µé¢ =====
              let value = null;
              try {
                await page.goto('https://www.feixiaohao.com/data/ahrdata.html', {
                  waitUntil: 'networkidle2',
                  timeout: 45000
                });
                await page.waitForSelector('div.val', { timeout: 20000 });
                await page.waitForTimeout(3000);  // ç­‰å¾…æ•°æ®ç¨³å®š
              
                value = await page.$eval('div.val', el => {
                  return parseFloat(el.textContent.replace(/[^0-9.]/g, '')) || null;
                });
              } catch (primaryError) {
                console.log('ä¸»æ•°æ®æºå¤±è´¥ï¼Œåˆ‡æ¢å¤‡ç”¨æº');
              }

              // ===== å¤‡ç”¨æ•°æ®æºï¼šAhr999å®˜æ–¹ =====
              if (value === null) {
                await page.goto('https://ahr999.com', {
                  waitUntil: 'domcontentloaded',
                  timeout: 30000
                });
                value = await page.$eval('#current_value', el => 
                  parseFloat(el.textContent.match(/\d+\.?\d*/)[0])
                );
              }

              console.log(`::set-output name=ahr999_value::${value}`);
            
            } catch (error) {
              console.log(`::error:: å…¨å±€æ•è· - ${error.message}`);
              console.log('::set-output name=ahr999_value::error');
            } finally {
              await browser.close();
            }
          })();

    # ========== æ™ºèƒ½æé†’æ¨¡å— ==========
    - name: åˆ†çº§è­¦æŠ¥ç³»ç»Ÿ
      if: |
        steps.data-crawler.outputs.ahr999_value != 'error' &&
        (steps.data-crawler.outputs.ahr999_value <= 0.8 || steps.data-crawler.outputs.ahr999_value >= 1.2)
      env:
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: |
        # æ•°å€¼æ ¼å¼åŒ–
        VALUE=$(printf "%.4f" ${{ steps.data-crawler.outputs.ahr999_value }})

        # åˆ†çº§ç­–ç•¥
        if (( $(echo "$VALUE <= 0.5" | bc -l) )); then
          TITLE="ğŸš¨ æåº¦ä½ä¼° (Ahr999=$VALUE)"
          CONTENT="ã€ç´§æ€¥æŠ„åº•ã€‘å½“å‰æŒ‡æ•°å·²è¿›å…¥å†å²åº•éƒ¨åŒºåŸŸï¼ˆ<0.5ï¼‰ï¼Œæ¨èç­–ç•¥ï¼š\n1. ä½¿ç”¨50%å¤‡ç”¨é‡‘ç«‹å³ä¹°å…¥\n2. å‰©ä½™èµ„é‡‘åˆ†3æ‰¹æŒ‚å•ï¼ˆ0.45/0.4/0.35ï¼‰\n3. ç»“åˆMVRV-Z <0éªŒè¯ä¿¡å·"
        elif (( $(echo "$VALUE <= 0.8" | bc -l) )); then
          TITLE="ğŸš© ä¸­åº¦ä½ä¼° (Ahr999=$VALUE)"
          CONTENT="ã€å®šæŠ•æ—¶æœºã€‘å½“å‰è¿›å…¥å®šæŠ•åŒºé—´ï¼ˆ0.5-0.8ï¼‰ï¼Œæ¨èç­–ç•¥ï¼š\n1. å¯åŠ¨å‘¨å®šæŠ•è®¡åˆ’\n2. æ¯ä¸‹è·Œ0.1å¢åŠ 20%ä»“ä½\n3. è®¾ç½®æ­¢æŸçº¿0.45"
        elif (( $(echo "$VALUE >= 1.2" | bc -l) )); then
          TITLE="âš ï¸ é£é™©åŒºåŸŸ (Ahr999=$VALUE)"
          CONTENT="ã€æ­¢ç›ˆé¢„è­¦ã€‘å½“å‰è¿›å…¥é«˜é£é™©åŒºåŸŸï¼ˆ>1.2ï¼‰ï¼Œæ¨èç­–ç•¥ï¼š\n1. åˆ†æ‰¹å–å‡ºï¼ˆ30%/50%/20%ï¼‰\n2. ä¿ç•™10%åº•ä»“è§‚æœ›\n3. å½“Ahr999x<0.3æ—¶æ¸…ä»“"
        fi

        # å‘é€é‚®ä»¶
        python3 -c "
        import smtplib, os
        from email.mime.text import MIMEText
      
        msg = MIMEText(os.environ['CONTENT'], 'plain', 'utf-8')
        msg['Subject'] = os.environ['TITLE']
        msg['From'] = os.environ['SMTP_USER']
        msg['To'] = os.environ['RECEIVER_EMAIL']
      
        with smtplib.SMTP_SSL('smtp.qq.com', 465) as server:
            server.login(os.environ['SMTP_USER'], os.environ['SMTP_PASSWORD'])
            server.sendmail(os.environ['SMTP_USER'], [os.environ['RECEIVER_EMAIL']], msg.as_string())
        "
      env:
        TITLE: ${{ env.TITLE }}
        CONTENT: ${{ env.CONTENT }}
