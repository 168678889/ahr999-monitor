name: Ahr999é¡µé¢ç›‘æ§
on:
  schedule:
    - cron: '*/15 * * * *'  # æ¯15åˆ†é’Ÿæ£€æµ‹ï¼ˆé™ä½å°ç¦é£é™©ï¼‰
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘è°ƒè¯•

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
    - name: å®‰è£…æµè§ˆå™¨ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser
      
    - name: åŠ¨æ€æŠ“å–æ•°æ®
      id: get-data
      uses: browser-actions/setup-puppeteer@v1.2.0
      with:
        args: |
          const puppeteer = require('puppeteer');
          (async () => {
            const browser = await puppeteer.launch({ 
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();
          
            // ä¼ªè£…æ­£å¸¸æµè§ˆå™¨è®¿é—®
            await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');
          
            try {
              // ä¸»æ•°æ®æºï¼šé£å°å·é¡µé¢
              await page.goto('https://www.feixiaohao.com/data/ahrdata.html', {
                waitUntil: 'networkidle2',
                timeout: 30000
              });
              await page.waitForSelector('.val', { timeout: 15000 });
              await page.waitForTimeout(2000);  // ç­‰å¾…æ•°å€¼ç¨³å®š
            
              const value = await page.$eval('.val', el => {
                const text = el.textContent.trim();
                return parseFloat(text) || null;
              });
            
              // å¤‡ç”¨æ•°æ®æºï¼šAhr999.com
              if (value === null) {
                await page.goto('https://ahr999.com', { waitUntil: 'networkidle2' });
                const backupValue = await page.$eval('#current_value', el => parseFloat(el.textContent));
                console.log(`::set-output name=ahr999::${backupValue}`);
              } else {
                console.log(`::set-output name=ahr999::${value}`);
              }
            
            } catch (error) {
              console.log('::error:: æ•°æ®æŠ“å–å¤±è´¥');
              console.log(`::set-output name=ahr999::error`);
            } finally {
              await browser.close();
            }
          })();

    - name: æ™ºèƒ½æé†’
      if: |
        steps.get-data.outputs.ahr999 != 'error' && 
        (steps.get-data.outputs.ahr999 <= 0.8 || steps.get-data.outputs.ahr999 >= 1.2)
      env:
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: |
        VALUE=$(echo "${{ steps.get-data.outputs.ahr999 }}" | bc -l)
      
        # åˆ†çº§æé†’ç­–ç•¥
        if (( $(echo "$VALUE <= 0.5" | bc -l) )); then
          MSG="ğŸ”¥ æåº¦ä½ä¼°ï¼Ahr999=$VALUEï¼Œå»ºè®®ç«‹å³æŠ„åº•"
        elif (( $(echo "$VALUE <= 0.8" | bc -l) )); then
          MSG="ğŸš© ä¸­åº¦ä½ä¼°ï¼Ahr999=$VALUEï¼Œå»ºè®®åˆ†æ‰¹å»ºä»“"
        elif (( $(echo "$VALUE >= 1.2" | bc -l) )); then
          MSG="âš ï¸ è¿›å…¥é«˜ä¼°ï¼Ahr999=$VALUEï¼Œå»ºè®®é€æ­¥å‡ä»“"
        fi
      
        python3 -c "
        import smtplib, os
        from email.mime.text import MIMEText
      
        msg = MIMEText(os.environ['MSG'], 'plain', 'utf-8')
        msg['Subject'] = 'Ahr999æŒ‡æ•°è­¦æŠ¥'
        msg['From'] = os.environ['SMTP_USER']
        msg['To'] = os.environ['RECEIVER_EMAIL']
      
        with smtplib.SMTP_SSL('smtp.qq.com', 465) as server:
            server.login(os.environ['SMTP_USER'], os.environ['SMTP_PASSWORD'])
            server.sendmail(os.environ['SMTP_USER'], [os.environ['RECEIVER_EMAIL']], msg.as_string())
        "
      env:
        MSG: ${{ env.MSG }}
