name: Ahr999æŒ‡æ•°ç›‘æ§ç³»ç»Ÿ
on:
  schedule:
    - cron: '30 * * * *'  # æ¯å°æ—¶ç¬¬30åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
    # ========== ç¯å¢ƒå‡†å¤‡ ==========
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          libnss3 \
          libatk1.0-0 \
          libx11-xcb1 \
          libxcb1 \
          libxcomposite1 \
          libxdamage1 \
          libxext6 \
          libxfixes3 \
          libxrandr2 \
          libgbm1

    - name: é…ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v3
      with:
        node-version: 18

    # ========== æ•°æ®æŠ“å–æ¨¡å— ==========
    - name: è·å–æŒ‡æ•°æ•°æ®
      id: data-crawler
      run: |
        node <<EOF
        const fs = require('fs');
        const puppeteer = require('puppeteer');

        (async () => {
          const browser = await puppeteer.launch({
            executablePath: '/usr/bin/chromium-browser',
            args: ['--no-sandbox', '--disable-setuid-sandbox']
          });

          try {
            const page = await browser.newPage();
          
            // å°è¯•å¤šä¸ªæ•°æ®æº
            const sources = [
              {
                url: 'https://www.feixiaohao.com/data/ahrdata.html',
                selector: 'div.val',
                handler: text => parseFloat(text.replace(/[^0-9.]/g, ''))
              },
              {
                url: 'https://ahr999.com',
                selector: '#current_value',
                handler: text => parseFloat(text.match(/\d+\.?\d*/)[0])
              }
            ];

            let finalValue = null;
            for (const source of sources) {
              try {
                await page.goto(source.url, {timeout: 60000});
                await page.waitForSelector(source.selector, {timeout: 15000});
                const text = await page.$eval(source.selector, el => el.textContent);
                finalValue = source.handler(text);
                break;
              } catch (e) {}
            }

            // å†™å…¥è¾“å‡ºå˜é‡
            fs.appendFileSync(
              process.env.GITHUB_OUTPUT, 
              `ahr999_value=${finalValue}`
            );
          } finally {
            await browser.close();
          }
        })();
        EOF

    # ========== é€šçŸ¥æ¨¡å— ==========
    - name: å‘é€é‚®ä»¶æé†’
      if: |
        steps.data-crawler.outputs.ahr999_value != '' &&
        (steps.data-crawler.outputs.ahr999_value <= 0.8 || steps.data-crawler.outputs.ahr999_value >= 1.2)
      env:
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: |
        python3 -c "
        import smtplib, os
        from email.mime.text import MIMEText

        value = ${{ steps.data-crawler.outputs.ahr999_value }}
      
        # åˆ†çº§å†…å®¹æ¨¡æ¿
        if value <= 0.45:
            subject = 'ğŸš¨ æåº¦ä½ä¼° (Ahr999=%.2f)' % value
            content = '''å»ºè®®ç«‹å³è¡ŒåŠ¨ï¼š
            - ä½¿ç”¨50%èµ„é‡‘æŠ„åº•
            - å‰©ä½™èµ„é‡‘åˆ†3æ‰¹æŒ‚å•(0.45/0.40/0.35)'''
        elif value <= 0.8:
            subject = 'ğŸš© ä¸­åº¦ä½ä¼° (Ahr999=%.2f)' % value
            content = '''å»ºè®®æ“ä½œï¼š
            - å¯åŠ¨å‘¨å®šæŠ•è®¡åˆ’
            - æ¯ä¸‹è·Œ0.1åŠ ä»“20%'''
        else:
            subject = 'âš ï¸ é£é™©é¢„è­¦ (Ahr999=%.2f)' % value
            content = '''å»ºè®®æ“ä½œï¼š
            - åˆ†æ‰¹å–å‡º(30%/50%/20%)
            - ä¿ç•™10%åº•ä»“'''

        # æ„å»ºé‚®ä»¶
        msg = MIMEText(content, 'plain', 'utf-8')
        msg['Subject'] = subject
        msg['From'] = f'ç›‘æ§ç³»ç»Ÿ <{os.environ["SMTP_USER"]}>'
        msg['To'] = os.environ["RECEIVER_EMAIL"]

        # å‘é€é‚®ä»¶
        with smtplib.SMTP_SSL('smtp.qq.com', 465) as server:
            server.login(os.environ["SMTP_USER"], os.environ["SMTP_PASSWORD"])
            server.sendmail(os.environ["SMTP_USER"], [os.environ["RECEIVER_EMAIL"]], msg.as_string())
        "
