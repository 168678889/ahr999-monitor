name: Ahr999ç»ˆæç›‘æ§
on:
  schedule:
    - cron: '20 * * * *'  # æ¯å°æ—¶ç¬¬20åˆ†é’Ÿè¿è¡Œï¼ˆé¿å¼€æ•´ç‚¹é«˜å³°ï¼‰
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # é˜²æ­¢åƒµå°¸è¿›ç¨‹
    steps:
    # ========== ç³»ç»Ÿçº§ä¾èµ–å®‰è£… ==========
    - name: å®‰è£…Chromiumå…¨å®¶æ¡¶
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-chromedriver \
          chromium-browser \
          fonts-liberation \
          libu2f-udev \
          fonts-noto-color-emoji
      
    # ========== æµè§ˆå™¨ç›‘æ§æ ¸å¿ƒ ==========
    - name: æ™ºèƒ½æ•°æ®æŠ“å–
      id: crawler
      uses: browser-actions/setup-puppeteer@v1.2.0
      with:
        args: |
          const puppeteer = require('puppeteer-core');  // ä½¿ç”¨ç¨³å®šç‰ˆæ ¸å¿ƒ
          (async () => {
            // é˜²å´©æºƒé…ç½®
            const browser = await puppeteer.launch({
              executablePath: '/usr/bin/chromium-browser',
              headless: 'new',
              args: [
                '--no-zygote',
                '--no-sandbox',
                '--disable-gpu',
                '--disable-dev-shm-usage',
                '--single-process',
                '--js-flags=--max-old-space-size=512'
              ],
              timeout: 90000
            });

            try {
              const page = await browser.newPage();
              await page.setDefaultNavigationTimeout(120000);
            
              // ===== å¤šé‡æ•°æ®æºå°è¯• =====
              const dataSources = [
                {
                  name: 'Feixiaohao',
                  url: 'https://www.feixiaohao.com/data/ahrdata.html',
                  selector: 'div.price-box > div.val',
                  handler: el => parseFloat(el.textContent.replace(/[^\d.]/g, ''))
                },
                {
                  name: 'Ahr999-Official',
                  url: 'https://ahr999.com',
                  selector: '#current_value',
                  handler: el => {
                    const text = el.textContent.match(/ahr999:\s*([\d.]+)/i);
                    return text ? parseFloat(text[1]) : null;
                  }
                },
                {
                  name: 'BlockWander',
                  url: 'https://blockwander.com/arh999-index/',
                  selector: 'div.indicator-value',
                  handler: el => parseFloat(el.textContent)
                }
              ];

              let finalValue = null;
              for (const source of dataSources) {
                try {
                  await page.goto(source.url, {
                    waitUntil: 'networkidle0',
                    timeout: 45000
                  });
                  await page.waitForSelector(source.selector, { timeout: 15000 });
                  await page.waitForTimeout(2000);  // ååçˆ¬å»¶è¿Ÿ
                
                  const value = await page.$eval(
                    source.selector,
                    source.handler
                  );
                
                  if (value && !isNaN(value)) {
                    console.log(`æ•°æ®æº ${source.name} æˆåŠŸè·å–: ${value}`);
                    finalValue = value;
                    break;
                  }
                } catch (err) {
                  console.log(`æ•°æ®æº ${source.name} å¤±è´¥: ${err.message}`);
                }
              }

              if (finalValue !== null) {
                console.log(`::set-output name=ahr999_value::${finalValue}`);
              } else {
                throw new Error('æ‰€æœ‰æ•°æ®æºå‡ä¸å¯ç”¨');
              }

            } catch (error) {
              console.log(`::error:: å…¨å±€é”™è¯¯ - ${error.message}`);
              process.exit(2);  // ç‰¹æ®Šé€€å‡ºç æ ‡è¯†
            } finally {
              await browser.close();
            }
          })();

    # ========== æ™ºèƒ½é€šçŸ¥ç³»ç»Ÿ ==========
    - name: é£é™©æ§åˆ¶ä¸­å¿ƒ
      if: |
        always() && 
        (steps.crawler.outcome == 'success' || steps.crawler.outcome == 'failure')
      run: |
        # çŠ¶æ€ç è§£æ
        if [ "${{ steps.crawler.outcome }}" = "failure" ]; then
          echo "::warning:: æ•°æ®æŠ“å–æœåŠ¡å¼‚å¸¸ï¼"
          python3 -c "
          import smtplib, os
          from email.mime.text import MIMEText
        
          msg = MIMEText('ç›‘æ§ç³»ç»Ÿæ•…éšœï¼Œè¯·åŠæ—¶æ£€æŸ¥ï¼', 'plain', 'utf-8')
          msg['Subject'] = 'ğŸš¨ ç›‘æ§ç³»ç»Ÿå‘Šè­¦'
          msg['From'] = os.environ['SMTP_USER']
          msg['To'] = os.environ['RECEIVER_EMAIL']
        
          with smtplib.SMTP_SSL('smtp.qq.com', 465) as server:
              server.login(os.environ['SMTP_USER'], os.environ['SMTP_PASSWORD'])
              server.sendmail(os.environ['SMTP_USER'], [os.environ['RECEIVER_EMAIL']], msg.as_string())
          "
        elif [ "${{ steps.crawler.outputs.ahr999_value }}" ]; then
          # æ­£å¸¸å¤„ç†æµç¨‹
          VALUE=${{ steps.crawler.outputs.ahr999_value }}
          # åˆ†çº§ç­–ç•¥...
        fi
      env:
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
