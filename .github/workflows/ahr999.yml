name: Ahr999ç›‘æ§ç³»ç»Ÿ
on:
  schedule:
    - cron: '30 * * * *'  # æ¯å°æ—¶ç¬¬30åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          libgbm-dev \
          libxshmfence-dev \
          libnss3 \
          libatk1.0-0 \
          libcups2 \
          libdrm2 \
          libxkbcommon0 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: å®‰è£…Puppeteeræ ¸å¿ƒ
      run: npm install puppeteer

    - name: æ•°æ®æŠ“å–
      id: crawler
      run: |
        node <<EOF
        const puppeteer = require('puppeteer');
        (async () => {
          const browser = await puppeteer.launch({
            executablePath: '/usr/bin/chromium-browser',
            args: [
              '--no-sandbox',
              '--disable-setuid-sandbox',
              '--disable-dev-shm-usage'
            ]
          });
        
          try {
            const page = await browser.newPage();
            await page.goto('https://www.feixiaohao.com/data/ahrdata.html', {
              waitUntil: 'networkidle2',
              timeout: 60000
            });
          
            // ç²¾å‡†å…ƒç´ å®šä½
            const value = await page.evaluate(() => {
              const element = document.querySelector('div.price-box > div.val');
              return element ? parseFloat(element.textContent.replace(/[^\d.]/g, '')) : null;
            });
          
            console.log(`::set-output name=ahr999_value::${value}`);
          } finally {
            await browser.close();
          }
        })();
        EOF

    - name: å‘é€æé†’
      if: |
        steps.crawler.outputs.ahr999_value != '' &&
        (steps.crawler.outputs.ahr999_value <= 0.8 || steps.crawler.outputs.ahr999_value >= 1.2)
      env:
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: |
        python3 -c "
        import smtplib, os
        from email.mime.text import MIMEText
      
        value = ${{ steps.crawler.outputs.ahr999_value }}
        if value <= 0.5:
            msg = 'ğŸš¨ æåº¦ä½ä¼°ï¼Ahr999æŒ‡æ•°ï¼š{:.4f}'.format(value)
        elif value <= 0.8:
            msg = 'ğŸš© ä¸­åº¦ä½ä¼°ï¼Ahr999æŒ‡æ•°ï¼š{:.4f}'.format(value)
        else:
            msg = 'âš ï¸ é£é™©é¢„è­¦ï¼Ahr999æŒ‡æ•°ï¼š{:.4f}'.format(value)
      
        message = MIMEText(msg, 'plain', 'utf-8')
        message['Subject'] = 'Ahr999ç›‘æ§æé†’'
        message['From'] = os.environ['SMTP_USER']
        message['To'] = os.environ['RECEIVER_EMAIL']
      
        with smtplib.SMTP_SSL('smtp.qq.com', 465) as server:
            server.login(os.environ['SMTP_USER'], os.environ['SMTP_PASSWORD'])
            server.sendmail(os.environ['SMTP_USER'], [os.environ['RECEIVER_EMAIL']], message.as_string())
        "
